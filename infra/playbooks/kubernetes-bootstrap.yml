# Note: make sure to load your KUBERNETES_MASTER_KEY environment variable before running this playbook

- name: Initialize the first Kubernetes master
  hosts: kube-master[0]
  become: yes
  vars:
    kube_version: "1.32.3"
    pod_network_cidr: "192.168.0.0/16"
    service_cidr: "10.96.0.0/12"
    cluster_name: "noo-cluster"
    control_plane_endpoint: "kube.internal.noo.eu:6443"

  pre_tasks:
    - name: Fail if the master key is not set
      fail:
        msg: "The KUBERNETES_MASTER_KEY environment variable is not set"
      when: not lookup('env', 'KUBERNETES_MASTER_KEY')

  roles:
    - role: kube-prep
      is_k8s_master: true
    - role: kube-install

  tasks:
    - name: Generate kubeadm config file
      copy:
        dest: /root/kubeadm-config.yaml
        content: |
          apiVersion: kubeadm.k8s.io/v1beta4
          kind: InitConfiguration
          nodeRegistration:
            criSocket: unix:///var/run/containerd/containerd.sock
          skipPhases:
            - addon/kube-proxy
          ---
          apiVersion: kubeadm.k8s.io/v1beta4
          kind: ClusterConfiguration
          kubernetesVersion: v{{ kube_version }}
          clusterName: {{ cluster_name }}
          controlPlaneEndpoint: "{{ control_plane_endpoint }}"
          networking:
            podSubnet: "{{ pod_network_cidr }}"
            serviceSubnet: "{{ service_cidr }}"
          apiServer:
            extraArgs:
              - name: encryption-provider-config
                value: /etc/kubernetes/pki/secrets-encryption.yaml
    - name: Initialize control plane
      command: kubeadm init --config=/root/kubeadm-config.yaml --upload-certs
      register: kubeadm_output
      changed_when: "kubeadm_output.rc == 0"
      failed_when: "kubeadm_output.rc != 0"

    - name: Display join command (safe for manual use)
      debug:
        var: kubeadm_output.stdout_lines

    - name: Set up kubeconfig for root
      shell: |
        mkdir -p /root/.kube && cp -i /etc/kubernetes/admin.conf /root/.kube/config
      args:
        creates: /root/.kube/config

    - name: Enable and start kubelet
      systemd:
        name: kubelet
        enabled: yes
        state: started
